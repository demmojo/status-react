#!/usr/bin/env bash

#
# Check if we need to copy node_modules (e.g. in case it has been modified after last copy)
#
# The reasoning for a (mostly) read-only node_modules folder:
#   ideally we’d symlink the folder directly to the Nix store
#   so that we’re guaranteed to have a reproducible source.
#   Unfortunately react-native wants to build some stuff after the fact
#   and this is incompatible with the concept of a pure Nix package.
#   Therefore we copy the whole source to the repo directory,
#   allow writing only on the folders where it is absolutely required,
#   and therefore we still keep some peace of mind that the rest
#   of node_modules is unchanged the rest of the time.
#

set -e

deps="$1"
[ -d $deps ] || exit 1

nodeModulesDir="$STATUS_REACT_HOME/node_modules"

needCopyModules=1
if [ -d $nodeModulesDir ]; then
  if [ -f $nodeModulesDir/.copied ]; then
    echo "Checking for modifications in node_modules..."
    modifiedFiles=$(find $nodeModulesDir -writable -type f -newer $nodeModulesDir/.copied)
    if [ $? -eq 0 ] && [ -z "$modifiedFiles" ]; then
      needCopyModules=0
      echo "No modifications detected."
    fi
  fi
  if [ $needCopyModules -eq 1 ]; then
    chmod u+w -R $nodeModulesDir
    rm -rf $nodeModulesDir
  fi
fi
if [ ! -d $nodeModulesDir ]; then
  echo "Copying node_modules from Nix store (${deps}/node_modules)..."
  if [ -d $nodeModulesDir.tmp ]; then
    echo "$nodeModulesDir.tmp already exists, another shell session is probably currently setting up node_modules. Please try again in a few moments."
    exit 1
  else
    time cp -HRf --preserve=all ${deps}/node_modules/. "$nodeModulesDir.tmp"
    chmod u+w "$nodeModulesDir.tmp"
    mv -f "$nodeModulesDir.tmp" $nodeModulesDir
    touch $nodeModulesDir/.copied
    chmod u-w $nodeModulesDir
    echo "Done"
  fi
fi

set +e